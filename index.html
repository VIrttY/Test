<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyMessenger</title>
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --bg-color: #ffffff;
            --text-color: #333333;
            --sidebar-bg: #f8f9fa;
            --chat-bg: #ffffff;
            --message-bg: #ffffff;
            --own-message-bg: #007bff;
            --border-color: #e9ecef;
        }

        [data-theme="dark"] {
            --bg-color: #1a1a1a;
            --text-color: #ffffff;
            --sidebar-bg: #2d2d2d;
            --chat-bg: #1a1a1a;
            --message-bg: #2d2d2d;
            --own-message-bg: #007bff;
            --border-color: #404040;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.3s ease;
        }

        .auth-container {
            background: var(--bg-color);
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .auth-form h2 {
            margin-bottom: 30px;
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--text-color);
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 16px;
        }

        .btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin: 10px 0;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .auth-switch {
            margin-top: 20px;
            color: var(--text-color);
        }

        .auth-switch a {
            color: var(--primary-color);
            cursor: pointer;
            text-decoration: underline;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            height: 90vh;
            background: var(--bg-color);
            color: var(--text-color);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: flex;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .sidebar {
            width: 300px;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-header h2 {
            color: var(--primary-color);
        }

        .btn-icon {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--text-color);
        }

        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chat-item {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background 0.3s;
            background: var(--bg-color);
        }

        .chat-item:hover {
            background: var(--primary-color);
            color: white;
        }

        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--sidebar-bg);
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: var(--chat-bg);
        }

        .message {
            max-width: 70%;
            padding: 12px 16px;
            margin-bottom: 15px;
            border-radius: 15px;
            background: var(--message-bg);
            border: 1px solid var(--border-color);
        }

        .message.own {
            background: var(--own-message-bg);
            color: white;
            margin-left: auto;
        }

        .message-input {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
        }

        .message-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background: var(--bg-color);
            color: var(--text-color);
        }

        .message-input button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: var(--bg-color);
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
        }

        .settings-section {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-section h3 {
            margin-bottom: 15px;
            color: var(--text-color);
        }

        /* Google Drive —Å—Ç–∏–ª–∏ */
        .drive-settings {
            background: var(--sidebar-bg);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
        }

        .drive-status {
            font-size: 12px;
            padding: 8px;
            border-radius: 5px;
            text-align: center;
            margin-top: 10px;
        }

        .drive-status.success {
            background: var(--success-color);
            color: white;
        }

        .drive-status.error {
            background: var(--danger-color);
            color: white;
        }

        .drive-status.loading {
            background: var(--info-color);
            color: white;
        }

        .auth-button {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px 0;
            width: 100%;
            font-size: 14px;
        }

        .auth-button:hover {
            opacity: 0.9;
        }

        .auth-button.logout {
            background: var(--danger-color);
        }

        .auto-sync-option {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            color: var(--text-color);
        }

        .theme-options {
            display: flex;
            gap: 10px;
        }

        .theme-option {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .theme-option.active {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
        }
    </style>
</head>
<body>
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-form" id="loginForm">
            <h2>–í—Ö–æ–¥ –≤ MyMessenger</h2>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="loginPassword" placeholder="–í–∞—à –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
            <div class="auth-switch">
                –ù–µ—Ç –∞–∫–∫–∞—É–Ω—Ç–∞? <a onclick="showRegister()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</a>
            </div>
        </div>

        <div class="auth-form" id="registerForm" style="display: none;">
            <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ MyMessenger</h2>
            <div class="form-group">
                <label>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                <input type="text" id="regUsername" placeholder="–í–∞—à username">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="regEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>–ü–∞—Ä–æ–ª—å</label>
                <input type="password" id="regPassword" placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å">
            </div>
            <button class="btn" onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div class="auth-switch">
                –£–∂–µ –µ—Å—Ç—å –∞–∫–∫–∞—É–Ω—Ç? <a onclick="showLogin()">–í–æ–π—Ç–∏</a>
            </div>
        </div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞ -->
    <div class="container messenger" id="messenger" style="display: none;">
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üí¨ MyMessenger</h2>
                <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
            <div class="chat-list" id="chatList">
                <!-- –ß–∞—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
        <div class="chat-area">
            <div class="chat-header">
                <h3 id="currentChatName">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
            </div>
            <div class="messages-container" id="messagesContainer">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleKeyPress(event)">
                <button onclick="sendMessage()">üì§</button>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
                <button class="close-btn" onclick="closeSettings()">√ó</button>
            </div>
            
            <!-- –°–µ–∫—Ü–∏—è Google Drive -->
            <div class="settings-section">
                <h3>üìÅ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Drive</h3>
                <div class="drive-settings">
                    <p><strong>–í–∞—à Client ID:</strong><br>499645189176-oeup4bbp3ot79jq33p7clgtja4gr6mst.apps.googleusercontent.com</p>
                    
                    <button id="driveAuthBtn" class="auth-button" onclick="authenticateWithDrive()">
                        üîê –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google Drive
                    </button>
                    
                    <button id="driveLogoutBtn" class="auth-button logout" onclick="logoutFromDrive()" style="display: none;">
                        üö™ –í—ã–π—Ç–∏ –∏–∑ Google Drive
                    </button>
                    
                    <div class="auto-sync-option">
                        <input type="checkbox" id="autoSyncDrive" onchange="toggleAutoSyncDrive()">
                        <label for="autoSyncDrive">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Drive</label>
                    </div>

                    <button class="btn" onclick="manualSyncToDrive()" style="background: var(--success-color); margin: 10px 0 5px 0;">
                        üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ Drive —Å–µ–π—á–∞—Å
                    </button>
                    <button class="btn" onclick="loadFromDrive()" style="background: var(--info-color); margin-bottom: 5px;">
                        üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Drive
                    </button>
                    
                    <div id="driveStatus" class="drive-status"></div>
                </div>
            </div>

            <div class="settings-section">
                <h3>üé® –¢–µ–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
                <div class="theme-options">
                    <div class="theme-option active" onclick="changeTheme('light')">
                        üåû –°–≤–µ—Ç–ª–∞—è
                    </div>
                    <div class="theme-option" onclick="changeTheme('dark')">
                        üåô –¢—ë–º–Ω–∞—è
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Google API Script -->
    <script src="https://apis.google.com/js/api.js"></script>

    <script>
        // ‚ö†Ô∏è –í–ê–ñ–ù–û: –í—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à –ù–û–í–´–ô API Key –∑–¥–µ—Å—å!
        const YOUR_API_KEY = 'AIzaSyAHDyJW2gk_d_wPw4hMtrZnmr-dYe5X-HE';

        class GoogleDriveManager {
            constructor() {
                this.CLIENT_ID = '499645189176-oeup4bbp3ot79jq33p7clgtja4gr6mst.apps.googleusercontent.com';
                this.API_KEY = 'AIzaSyAHDyJW2gk_d_wPw4hMtrZnmr-dYe5X-HE';
                
                this.DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
                this.SCOPES = 'https://www.googleapis.com/auth/drive.file';
                
                this.isAutoSyncEnabled = localStorage.getItem('drive_auto_sync') === 'true';
                this.isAuthenticated = false;
                this.gapiLoaded = false;
                
                this.loadGAPI();
            }

            loadGAPI() {
                gapi.load('client:auth2', () => {
                    this.initClient();
                });
            }

            async initClient() {
                try {
                    await gapi.client.init({
                        apiKey: this.API_KEY,
                        clientId: this.CLIENT_ID,
                        discoveryDocs: this.DISCOVERY_DOCS,
                        scope: this.SCOPES
                    });
                    
                    this.gapiLoaded = true;
                    
                    gapi.auth2.getAuthInstance().isSignedIn.listen((isSignedIn) => {
                        this.handleAuthChange(isSignedIn);
                    });

                    this.handleAuthChange(gapi.auth2.getAuthInstance().isSignedIn.get());
                    
                } catch (error) {
                    console.error('Error initializing Google API:', error);
                    showDriveStatus('–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Google API', 'error');
                }
            }

            handleAuthChange(isSignedIn) {
                this.isAuthenticated = isSignedIn;
                this.updateAuthUI();
                
                if (isSignedIn) {
                    showDriveStatus('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ Google Drive!', 'success');
                }
            }

            updateAuthUI() {
                const authBtn = document.getElementById('driveAuthBtn');
                const logoutBtn = document.getElementById('driveLogoutBtn');
                
                if (this.isAuthenticated) {
                    authBtn.style.display = 'none';
                    logoutBtn.style.display = 'block';
                } else {
                    authBtn.style.display = 'block';
                    logoutBtn.style.display = 'none';
                }
            }

            async authenticate() {
                if (!this.gapiLoaded) {
                    showDriveStatus('Google API –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error');
                    return;
                }

                try {
                    await gapi.auth2.getAuthInstance().signIn();
                    return { success: true };
                } catch (error) {
                    console.error('Auth error:', error);
                    showDriveStatus(`‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }
            }

            async logout() {
                if (!this.gapiLoaded) return;
                
                try {
                    await gapi.auth2.getAuthInstance().signOut();
                    showDriveStatus('üö™ –í—ã—à–ª–∏ –∏–∑ Google Drive', 'success');
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }

            async findOrCreateFile() {
                if (!this.isAuthenticated) {
                    throw new Error('Not authenticated');
                }

                const response = await gapi.client.drive.files.list({
                    q: "name='mymessenger_data.json' and trashed=false",
                    fields: 'files(id, name)',
                    spaces: 'drive'
                });

                if (response.result.files.length > 0) {
                    return response.result.files[0].id;
                }

                const fileMetadata = {
                    name: 'mymessenger_data.json',
                    mimeType: 'application/json'
                };

                const createResponse = await gapi.client.drive.files.create({
                    resource: fileMetadata,
                    fields: 'id'
                });

                return createResponse.result.id;
            }

            async saveToDrive(data) {
                if (!this.isAuthenticated) {
                    throw new Error('Not authenticated');
                }

                showDriveStatus('‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Drive...', 'loading');

                try {
                    const fileId = await this.findOrCreateFile();
                    const fileContent = JSON.stringify(data, null, 2);
                    
                    await gapi.client.drive.files.update({
                        fileId: fileId,
                        uploadType: 'media',
                        media: {
                            mimeType: 'application/json',
                            body: fileContent
                        }
                    });

                    showDriveStatus('‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Google Drive!', 'success');
                    return { success: true, fileId: fileId };
                    
                } catch (error) {
                    console.error('Save error:', error);
                    showDriveStatus(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }
            }

            async loadFromDrive() {
                if (!this.isAuthenticated) {
                    throw new Error('Not authenticated');
                }

                showDriveStatus('‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑ Drive...', 'loading');

                try {
                    const fileId = await this.findOrCreateFile();
                    
                    const response = await gapi.client.drive.files.get({
                        fileId: fileId,
                        alt: 'media'
                    });

                    const data = JSON.parse(response.body);
                    showDriveStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ Drive!', 'success');
                    
                    return { success: true, data: data };
                    
                } catch (error) {
                    console.error('Load error:', error);
                    showDriveStatus(`‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}`, 'error');
                    return { success: false, error: error.message };
                }
            }

            setAutoSync(enabled) {
                this.isAutoSyncEnabled = enabled;
                localStorage.setItem('drive_auto_sync', enabled);
            }
        }

        class MessengerServer {
            constructor() {
                this.users = JSON.parse(localStorage.getItem('messenger_users')) || [];
                this.chats = JSON.parse(localStorage.getItem('messenger_chats')) || [];
                this.messages = JSON.parse(localStorage.getItem('messenger_messages')) || [];
                this.settings = JSON.parse(localStorage.getItem('messenger_settings')) || { theme: 'light' };
            }

            register(userData) {
                if (this.users.find(u => u.email === userData.email)) {
                    return { error: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç' };
                }
                if (this.users.find(u => u.username === userData.username)) {
                    return { error: '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–Ω—è—Ç–æ' };
                }

                const newUser = {
                    id: Date.now(),
                    username: userData.username,
                    email: userData.email,
                    password: userData.password,
                    avatar: userData.username[0].toUpperCase(),
                    registeredAt: new Date().toISOString()
                };

                this.users.push(newUser);
                this.saveUsers();

                // –°–æ–∑–¥–∞–µ–º welcome —á–∞—Ç
                const welcomeChat = {
                    id: Date.now() + 1,
                    name: "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!",
                    type: "welcome",
                    avatar: "üëã",
                    members: [newUser.id],
                    createdBy: "system",
                    createdAt: new Date().toISOString()
                };

                this.chats.push(welcomeChat);
                this.saveChats();

                const welcomeMessage = {
                    id: Date.now() + 2,
                    chatId: welcomeChat.id,
                    senderId: "system",
                    senderName: "–°–∏—Å—Ç–µ–º–∞",
                    text: `–ü—Ä–∏–≤–µ—Ç, ${userData.username}! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ MyMessenger.`,
                    time: new Date().toLocaleTimeString('ru-RU'),
                    timestamp: new Date().toISOString(),
                    status: 'read'
                };

                this.messages.push(welcomeMessage);
                this.saveMessages();

                return { success: true, user: newUser };
            }

            login(credentials) {
                const user = this.users.find(u => u.email === credentials.email && u.password === credentials.password);
                if (user) {
                    user.lastSeen = new Date().toISOString();
                    this.saveUsers();
                    return { success: true, user };
                } else {
                    return { error: '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å' };
                }
            }

            saveUsers() { localStorage.setItem('messenger_users', JSON.stringify(this.users)); }
            saveChats() { localStorage.setItem('messenger_chats', JSON.stringify(this.chats)); }
            saveMessages() { localStorage.setItem('messenger_messages', JSON.stringify(this.messages)); }
            saveSettings() { localStorage.setItem('messenger_settings', JSON.stringify(this.settings)); }

            getAllData() {
                return {
                    users: this.users,
                    chats: this.chats,
                    messages: this.messages,
                    settings: this.settings,
                    last_sync: new Date().toISOString()
                };
            }

            restoreData(data) {
                if (data.users) {
                    this.users = data.users;
                    this.saveUsers();
                }
                if (data.chats) {
                    this.chats = data.chats;
                    this.saveChats();
                }
                if (data.messages) {
                    this.messages = data.messages;
                    this.saveMessages();
                }
                if (data.settings) {
                    this.settings = data.settings;
                    this.saveSettings();
                    changeTheme(data.settings.theme || 'light');
                }
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        const driveManager = new GoogleDriveManager();
        const server = new MessengerServer();
        let currentUser = null;
        let currentChat = null;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Google Drive
        async function authenticateWithDrive() {
            const result = await driveManager.authenticate();
        }

        function logoutFromDrive() {
            driveManager.logout();
        }

        function toggleAutoSyncDrive() {
            const autoSync = document.getElementById('autoSyncDrive').checked;
            driveManager.setAutoSync(autoSync);
            showDriveStatus(`–ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è ${autoSync ? '–≤–∫–ª—é—á–µ–Ω–∞' : '–≤—ã–∫–ª—é—á–µ–Ω–∞'}`, 'success');
        }

        async function manualSyncToDrive() {
            if (!driveManager.isAuthenticated) {
                showDriveStatus('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ Google Drive', 'error');
                return;
            }

            const data = server.getAllData();
            await driveManager.saveToDrive(data);
        }

        async function loadFromDrive() {
            if (!driveManager.isAuthenticated) {
                showDriveStatus('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ Google Drive', 'error');
                return;
            }

            const result = await driveManager.loadFromDrive();
            if (result.success) {
                server.restoreData(result.data);
                showDriveStatus('‚úÖ –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        }

        function showDriveStatus(message, type) {
            const statusElement = document.getElementById('driveStatus');
            statusElement.textContent = message;
            statusElement.className = `drive-status ${type}`;
        }

        // –§—É–Ω–∫—Ü–∏–∏ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–∞
        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('registerForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        function register() {
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;

            if (!username || !email || !password) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            const result = server.register({ username, email, password });
            
            if (result.error) {
                alert(result.error);
                return;
            }

            alert('‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç.');
            showLogin();
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const result = server.login({ email, password });

            if (result.success) {
                currentUser = result.user;
                document.getElementById('authContainer').style.display = 'none';
                document.getElementById('messenger').style.display = 'flex';
                loadChats();
                loadSettings();
            } else {
                alert('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å!');
            }
        }

        function loadChats() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            
            server.chats.filter(chat => chat.members.includes(currentUser.id)).forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.innerHTML = `
                    <strong>${chat.avatar} ${chat.name}</strong>
                    <div style="font-size: 12px; opacity: 0.7;">${chat.type === 'welcome' ? '–°–∏—Å—Ç–µ–º–Ω—ã–π —á–∞—Ç' : '–ß–∞—Ç'}</div>
                `;
                chatItem.onclick = () => openChat(chat);
                chatList.appendChild(chatItem);
            });
        }

        function openChat(chat) {
            currentChat = chat;
            document.getElementById('currentChatName').textContent = `${chat.avatar} ${chat.name}`;
            
            const messagesContainer = document.getElementById('messagesContainer');
            messagesContainer.innerHTML = '';
            
            const chatMessages = server.messages.filter(msg => msg.chatId === chat.id);
            chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.senderId === currentUser.id ? 'own' : ''}`;
                messageDiv.innerHTML = `
                    <div><strong>${msg.senderName}</strong></div>
                    <div>${msg.text}</div>
                    <div style="font-size: 12px; opacity: 0.7; text-align: right;">${msg.time}</div>
                `;
                messagesContainer.appendChild(messageDiv);
            });
            
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentChat) return;
            
            const message = {
                id: Date.now(),
                chatId: currentChat.id,
                senderId: currentUser.id,
                senderName: currentUser.username,
                text: text,
                time: new Date().toLocaleTimeString('ru-RU'),
                timestamp: new Date().toISOString(),
                status: 'sent'
            };
            
            server.messages.push(message);
            server.saveMessages();
            
            if (driveManager.isAutoSyncEnabled && driveManager.isAuthenticated) {
                const data = server.getAllData();
                driveManager.saveToDrive(data);
            }
            
            input.value = '';
            openChat(currentChat);
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function openSettings() {
            document.getElementById('autoSyncDrive').checked = driveManager.isAutoSyncEnabled;
            document.getElementById('settingsModal').style.display = 'block';
        }

        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function changeTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            server.settings.theme = theme;
            server.saveSettings();
            
            document.querySelectorAll('.theme-option').forEach(opt => {
                opt.classList.remove('active');
            });
            event.target.classList.add('active');
        }

        function loadSettings() {
            if (server.settings.theme) {
                changeTheme(server.settings.theme);
            }
        }

        // –ê–≤—Ç–æ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö
        function setupAutoSave() {
            const originalSaveUsers = server.saveUsers.bind(server);
            const originalSaveChats = server.saveChats.bind(server);
            const originalSaveMessages = server.saveMessages.bind(server);
            
            server.saveUsers = function() {
                originalSaveUsers();
                if (driveManager.isAutoSyncEnabled && driveManager.isAuthenticated) {
                    const data = server.getAllData();
                    driveManager.saveToDrive(data);
                }
            };
            
            server.saveChats = function() {
                originalSaveChats();
                if (driveManager.isAutoSyncEnabled && driveManager.isAuthenticated) {
                    const data = server.getAllData();
                    driveManager.saveToDrive(data);
                }
            };
            
            server.saveMessages = function() {
                originalSaveMessages();
                if (driveManager.isAutoSyncEnabled && driveManager.isAuthenticated) {
                    const data = server.getAllData();
                    driveManager.saveToDrive(data);
                }
            };
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        window.addEventListener('load', function() {
            setupAutoSave();
            loadSettings();
        });
    </script>
</body>
</html>